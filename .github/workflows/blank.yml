name: FFmpeg HLS to Telegram RTMP with Watermark

on:
  workflow_dispatch:
    inputs:
      INPUT_URL:
        description: "URL HLS (m3u8)"
        required: true
        type: string
      REFERER_HEADER:
        description: "Referer header (optional)"
        required: false
        type: string
        default: ""
      ORIGIN_HEADER:
        description: "Origin header (optional)"
        required: false
        type: string
        default: ""
      USER_AGENT:
        description: "User-Agent header (optional)"
        required: false
        type: string
        default: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36"

jobs:
  stream:
    runs-on: ubuntu-latest

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Start Streaming (FFmpeg only)
        env:
          INPUT_URL: ${{ inputs.INPUT_URL }}
          REFERER_HEADER: ${{ inputs.REFERER_HEADER }}
          ORIGIN_HEADER: ${{ inputs.ORIGIN_HEADER }}
          USER_AGENT: ${{ inputs.USER_AGENT }}
          RTMP_URL: ${{ secrets.RTMP_URL }}
        run: |
          set -euo pipefail

          if [ -z "${RTMP_URL:-}" ]; then
            echo "RTMP_URL belum diset di Secrets!"
            exit 1
          fi

          echo "::add-mask::$RTMP_URL"

          # Gabungkan header (urut: Referer -> Origin -> UA)
          HDR=""
          if [ -n "$REFERER_HEADER" ]; then
            HDR="${HDR}Referer: ${REFERER_HEADER}\r\n"
          fi
          if [ -n "$ORIGIN_HEADER" ]; then
            HDR="${HDR}Origin: ${ORIGIN_HEADER}\r\n"
          fi
          if [ -n "$USER_AGENT" ]; then
            HDR="${HDR}User-Agent: ${USER_AGENT}\r\n"
          fi

          echo "Starting FFmpeg streaming..."
          ffmpeg -hide_banner -loglevel info \
            -re \
            -headers "$HDR" \
            -i "$INPUT_URL" \
            -vf "drawtext=text='TipiStream':fontcolor=white:fontsize=24:x=180:y=180" \
            -c:v libx264 -preset veryfast -tune zerolatency \
            -c:a aac -b:a 128k -ar 44100 \
            -f flv "$RTMP_URL"
